<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>ProKanban</title>
    <style>
:root {
    --bg: #f1f5f9;
    --column-bg: #e2e8f0;
    --card-bg: #ffffff;
    --text-main: #1e293b;
    --primary: #3b82f6;
    --danger: #dc2626;
    --success: #00b894;
    --q1: #fee2e2; --q2: #dbeafe; --q3: #fef9c3; --q4: #f1f5f9;
}

body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text-main); margin: 0; padding-bottom: 80px; }
header { background: #fff; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #cbd5e1; position: sticky; top: 0; z-index: 1000; }

.header-btns { display: flex; gap: 10px; }
.search-bar { padding: 0.5rem 1rem; border: 1px solid #cbd5e1; border-radius: 20px; outline: none; width: 200px; }

/* Kanban Layout */
.board { display: flex; gap: 1.5rem; padding: 1.5rem; overflow-x: auto; align-items: flex-start; }
.column { background-color: var(--column-bg); width: 350px; min-width: 350px; border-radius: 12px; display: flex; flex-direction: column; transition: 0.2s; border: 2px solid transparent; }
.column-header { padding: 1rem; font-weight: 700; display: flex; justify-content: space-between; }
.task-list { padding: 0 0.75rem 0.75rem; min-height: 100px; }

/* Karten Design */
.card { background: var(--card-bg); border-radius: 8px; padding: 12px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: grab; position: relative; border-left: 6px solid #ccc; transition: 0.2s; }
.card:hover { transform: translateY(-2px); border-color: var(--primary); }
.card.q1 { border-left-color: var(--danger); }
.card.q2 { border-left-color: #3b82f6; }
.card.q3 { border-left-color: #f59e0b; }
.card.q4 { border-left-color: #94a3b8; }
.card-text { font-size: 0.95rem; font-weight: 600; margin-bottom: 5px; color: var(--text-main); }
.card-meta { font-size: 0.7rem; color: #64748b; display: flex; justify-content: space-between; align-items: center; }

/* Men√º Buttons */
.card-menu-btn, .sync-menu-btn { background: none; border: none; color: #94a3b8; cursor: pointer; font-size: 18px; padding: 2px 6px; border-radius: 4px; }
.card-menu-btn:hover, .sync-menu-btn:hover { background: #f1f5f9; color: var(--text-main); }

/* Input Bereich */
.input-group { padding: 10px; background: #fff; border-radius: 0 0 12px 12px; border-top: 1px solid #cbd5e1; }
.input-row { display: flex; gap: 5px; margin-bottom: 5px; }
.input-row input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px; }
.check-row { display: flex; gap: 15px; font-size: 0.75rem; color: #64748b; padding-left: 5px; }

/* Eisenhower Matrix */
.matrix-wrapper { max-width: 1100px; margin: 40px auto; display: grid; grid-template-columns: 60px 1fr 1fr; grid-template-rows: 40px minmax(250px, auto) minmax(250px, auto); gap: 15px; padding: 10px; }
.axis-label { font-weight: bold; color: #64748b; text-transform: uppercase; font-size: 0.8rem; display: flex; align-items: center; justify-content: center; white-space: nowrap; }
.label-x-1 { grid-column: 2; grid-row: 1; } .label-x-2 { grid-column: 3; grid-row: 1; }
.label-y { writing-mode: vertical-rl; transform: rotate(180deg); }
.label-y-wichtig { grid-column: 1; grid-row: 2; } .label-y-nicht-wichtig { grid-column: 1; grid-row: 3; }
#q1 { grid-column: 2; grid-row: 2; } #q2 { grid-column: 3; grid-row: 2; }
#q3 { grid-column: 2; grid-row: 3; } #q4 { grid-column: 3; grid-row: 3; }
.quadrant { background: #fff; border-radius: 12px; padding: 15px; border: 2px solid transparent; transition: 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

/* Modals */
.modal { display: none; position: fixed; z-index: 10001; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); align-items: center; justify-content: center; }
.modal-content { background: white; padding: 25px; border-radius: 20px; width: 90%; max-width: 450px; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
.close-btn { position: absolute; top: 15px; right: 15px; cursor: pointer; font-size: 20px; color: #94a3b8; }

/* Sync Manager Styles */
.sync-controls-row { display: flex; gap: 8px; margin-bottom: 15px; align-items: center; }
.sync-select { flex: 1; padding: 10px; background: #f8fafc; border: 1px solid #cbd5e1; border-radius: 12px; font-weight: bold; font-size: 13px; outline: none; }
.sync-icon-btn { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: #e2e8f0; border-radius: 12px; cursor: pointer; font-size: 18px; }
.sync-main-btn { padding: 12px; border-radius: 12px; border: none; font-weight: bold; font-size: 13px; display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; flex: 1; }

/* Kontext Men√º */
.context-menu { position: fixed; display: none; background: white; border: 1px solid #cbd5e1; border-radius: 8px; box-shadow: 0 10px 15px rgba(0,0,0,0.1); z-index: 11000; min-width: 150px; overflow: hidden; }
.context-item { padding: 10px 15px; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 10px; color: var(--text-main); }
.context-item:hover { background: #f8fafc; }
.context-item.danger { color: var(--danger); border-top: 1px solid #f1f5f9; }

/* Utils */
.progress-container { width: 100%; background: #eee; border-radius: 10px; margin: 15px 0; height: 10px; overflow: hidden; }
.progress-bar { height: 100%; background: var(--success); width: 0%; transition: width 0.3s; }
.error-toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 24px; border-radius: 50px; z-index: 100000; font-size: 14px; display: none; }
.dragging { opacity: 0.3; }
.drag-over { background-color: #d1d5db !important; border-color: var(--primary) !important; }
/* Karten-Container vorbereiten */
.card {
    background: var(--card-bg);
    border-radius: 8px;
    padding: 12px;
    padding-right: 30px; /* PLATZ RECHTS: Damit Text nicht unter den Button rutscht */
    margin-bottom: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    cursor: grab;
    position: relative; /* WICHTIG: Bezugspunkt f√ºr absolute Positionierung */
    border-left: 6px solid #ccc;
    transition: 0.2s;
}

/* Button exakt oben rechts positionieren */
.card-menu-btn {
    position: absolute;
    top: 5px;    /* Abstand von oben */
    right: 5px;  /* Abstand von rechts */
    background: none;
    border: none;
    color: #94a3b8;
    cursor: pointer;
    font-size: 18px;
    line-height: 1;
    padding: 4px 8px;
    border-radius: 4px;
    z-index: 10; /* √úber dem Text halten */
}

.card-menu-btn:hover {
    background: #f1f5f9;
    color: var(--text-main);
}  

  </style>
</head>
<body>

<div id="errorToast" class="error-toast"></div>

<header>
    <h2 style="margin:0; color:var(--primary); font-size: 1.2rem;">ProKanban</h2>
    <input type="text" class="search-bar" id="search" placeholder="Suchen..." oninput="render()">
    <div class="header-btns">
        <button class="btn-secondary" onclick="openSyncModal()">‚òÅÔ∏è Sync & Backup</button>
        <button style="color:var(--danger); border:1px solid #fecaca; background:#fee2e2; padding:6px 12px; border-radius:8px; cursor:pointer; font-weight:bold;" onclick="clearAll()">Reset</button>
    </div>
</header>

<!-- Board & Matrix (unver√§ndert) -->
<div class="board">
    <div class="column" id="col-todo" ondrop="drop(event, 'todo')" ondragover="allowDrop(event)" ondragleave="clearStyle(event)">
        <div class="column-header">üìã To Do</div>
        <div class="task-list" id="list-todo"></div>
        <div class="input-group">
            <div class="input-row"><input type="text" id="in-todo" placeholder="Neu..."><button onclick="addTask('todo')" class="btn-primary">+</button></div>
            <div class="check-row">
                <label><input type="checkbox" id="u-todo"> Dringend ‚ö°</label>
                <label><input type="checkbox" id="i-todo"> Wichtig ‚≠ê</label>
            </div>
        </div>
    </div>
    <div class="column" id="col-doing" ondrop="drop(event, 'doing')" ondragover="allowDrop(event)" ondragleave="clearStyle(event)">
        <div class="column-header">‚ö° In Arbeit</div>
        <div class="task-list" id="list-doing"></div>
        <div class="input-group">
            <div class="input-row"><input type="text" id="in-doing" placeholder="Neu..."><button onclick="addTask('doing')" class="btn-primary">+</button></div>
            <div class="check-row">
                <label><input type="checkbox" id="u-doing"> Dringend ‚ö°</label>
                <label><input type="checkbox" id="i-doing"> Wichtig ‚≠ê</label>
            </div>
        </div>
    </div>
    <div class="column" id="col-done" ondrop="drop(event, 'done')" ondragover="allowDrop(event)" ondragleave="clearStyle(event)">
        <div class="column-header">‚úÖ Erledigt</div>
        <div class="task-list" id="list-done"></div>
        <div class="input-group">
            <div class="input-row"><input type="text" id="in-done" placeholder="Neu..."><button onclick="addTask('done')" class="btn-primary">+</button></div>
            <div class="check-row">
                <label><input type="checkbox" id="u-done"> Dringend ‚ö°</label>
                <label><input type="checkbox" id="i-done"> Wichtig ‚≠ê</label>
            </div>
        </div>
    </div>
</div>

<div class="matrix-wrapper">
    <div class="axis-label label-x-1">Dringend</div>
    <div class="axis-label label-x-2">Nicht Dringend</div>
    <div class="axis-label label-y label-y-wichtig">Wichtig</div>
    <div class="quadrant" id="q1" ondrop="dropMatrix(event, true, true)" ondragover="allowDrop(event)" ondragleave="clearStyle(event)">
        <h4>üî• Q1: SOFORT TUN</h4>
        <div class="quad-list" id="list-q1"></div>
    </div>
    <div class="quadrant" id="q2" ondrop="dropMatrix(event, false, true)" ondragover="allowDrop(event)" ondragleave="clearStyle(event)">
        <h4>üìÖ Q2: TERMINIEREN</h4>
        <div class="quad-list" id="list-q2"></div>
    </div>
    <div class="axis-label label-y label-y-nicht-wichtig">Nicht Wichtig</div>
    <div class="quadrant" id="q3" ondrop="dropMatrix(event, true, false)" ondragover="allowDrop(event)" ondragleave="clearStyle(event)">
        <h4>ü§ù Q3: DELEGIEREN</h4>
        <div class="quad-list" id="list-q3"></div>
    </div>
    <div class="quadrant" id="q4" ondrop="dropMatrix(event, false, false)" ondragover="allowDrop(event)" ondragleave="clearStyle(event)">
        <h4>üóëÔ∏è Q4: ELIMINIEREN</h4>
        <div class="quad-list" id="list-q4"></div>
    </div>
</div>

<!-- === MODALS === -->
<!-- Haupt-Sync Modal -->
<div id="syncModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('syncModal')">‚úï</span>
        <h3>‚òÅÔ∏è Cloud Sync Manager</h3>
        
        <div class="sync-controls-row">
            <select id="syncChannelSelect" class="sync-select" onchange="onSyncChannelChange()">
                <option value="" disabled selected>-- Kanal w√§hlen --</option>
            </select>
            <div class="sync-icon-btn" onclick="openAddSyncModal()" title="Neuer Kanal" style="background:var(--primary); color:white;">+</div>
            <div class="sync-icon-btn" onclick="openSyncChannelMenu(event)" title="Optionen">‚ãÆ</div>
        </div>

        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <button class="sync-main-btn" style="background:linear-gradient(135deg, var(--primary), #1d4ed8); color:white;" onclick="startCloudPush()">
                <span>üì§</span> Hochladen
            </button>
            <button class="sync-main-btn" style="background:var(--card-bg); border:1px solid #cbd5e1;" onclick="checkForCloudBackups()">
                <span>üîÑ</span> Pr√ºfen
            </button>
        </div>

        <hr style="opacity:0.2">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:20px;">
            <button style="padding:10px; border-radius:8px; border:1px solid #ddd; cursor:pointer;" onclick="downloadBackup()">üì¶ Backup (.json)</button>
            <button style="padding:10px; border-radius:8px; border:1px solid #ddd; cursor:pointer;" onclick="document.getElementById('importFile').click()">üì• Import</button>
            <input type="file" id="importFile" accept=".json" hidden onchange="importBackup(event)">
        </div>

        <div id="syncListContainer" style="display:none; margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
            <div id="syncListItems" style="max-height:150px; overflow-y:auto;"></div>
        </div>
    </div>
</div>

<!-- Sub-Modal: Kanal Hinzuf√ºgen/Bearbeiten -->
<div id="syncAddModal" class="modal" style="z-index:22000;">
    <div class="modal-content" style="max-width:350px;">
        <h3 id="syncAddTitle">Neuer Sync-Kanal</h3>
        <input id="newSyncName" placeholder="Name (z.B. Office-PC)" style="width:100%; padding:10px; margin-bottom:10px; border-radius:8px; border:1px solid #ddd;">
        <input id="newSyncTopic" placeholder="ntfy Kanal-ID (geheim)" style="width:100%; padding:10px; margin-bottom:10px; border-radius:8px; border:1px solid #ddd; font-family:monospace;">
        <input id="newSyncPass" type="password" placeholder="Passwort (Verschl√ºsselung)" style="width:100%; padding:10px; margin-bottom:20px; border-radius:8px; border:1px solid #ddd;">
        
        <div style="display:flex; gap:10px;">
            <button style="flex:1; background:var(--primary); color:white; border:none; padding:12px; border-radius:8px; cursor:pointer; font-weight:bold;" onclick="saveNewSyncChannel()">Speichern</button>
            <button style="flex:1; background:#eee; border:none; padding:12px; border-radius:8px; cursor:pointer;" onclick="closeModal('syncAddModal')">Abbrechen</button>
        </div>
    </div>
</div>

<!-- Progress Modal -->
<div id="syncProgressModal" class="modal" style="z-index:30000;">
    <div class="modal-content" style="text-align:center;">
        <h3 id="syncProgressTitle">Sync l√§uft...</h3>
        <p id="syncProgressStatus" style="font-size:12px; opacity:0.7;">Verbinde...</p>
        <div class="progress-container"><div id="syncProgressBar" class="progress-bar"></div></div>
    </div>
</div>

<!-- Einziges Kontextmen√º f√ºr Karten UND Sync-Manager -->
<div id="cardContextMenu" class="context-menu"></div>

<script>
 /* === GLOBAL STATE === */
let tasks = JSON.parse(localStorage.getItem('kanban-v4-1')) || [];
let syncChannels = JSON.parse(localStorage.getItem('tier_sync_channels')) || [];
let activeSyncId = localStorage.getItem('tier_active_sync_id') || null;
let currentMenuTaskId = null;
let editingSyncId = null;

// Initialisierung
window.addEventListener('DOMContentLoaded', () => {
    renderSyncUI();
    render();
});

/* === SYNC CHANNEL MANAGER === */
function renderSyncUI() {
    const sel = document.getElementById('syncChannelSelect');
    if(!sel) return;
    sel.innerHTML = '<option value="" disabled selected>-- Kanal w√§hlen --</option>';
    syncChannels.forEach(ch => {
        const opt = document.createElement('option');
        opt.value = ch.id;
        opt.innerText = (ch.password ? "üîí " : "") + ch.name;
        if(ch.id === activeSyncId) opt.selected = true;
        sel.appendChild(opt);
    });
}

function onSyncChannelChange() {
    activeSyncId = document.getElementById('syncChannelSelect').value;
    localStorage.setItem('tier_active_sync_id', activeSyncId);
}

function openAddSyncModal() {
    editingSyncId = null;
    document.getElementById('syncAddTitle').innerText = "Neuer Sync-Kanal";
    document.getElementById('newSyncName').value = '';
    document.getElementById('newSyncTopic').value = '';
    document.getElementById('newSyncPass').value = '';
    document.getElementById('syncAddModal').style.display = 'flex';
}

function editSyncChannel(id) {
    const ch = syncChannels.find(c => c.id === id);
    if(!ch) return;
    editingSyncId = id;
    document.getElementById('syncAddTitle').innerText = "Kanal bearbeiten";
    document.getElementById('newSyncName').value = ch.name;
    document.getElementById('newSyncTopic').value = ch.topic;
    document.getElementById('newSyncPass').value = ch.password || '';
    document.getElementById('syncAddModal').style.display = 'flex';
}

function saveNewSyncChannel() {
    const name = document.getElementById('newSyncName').value.trim();
    const topic = document.getElementById('newSyncTopic').value.trim();
    const password = document.getElementById('newSyncPass').value.trim();
    if(!name || !topic) return alert("Name und ID erforderlich!");

    if (editingSyncId) {
        const idx = syncChannels.findIndex(c => c.id === editingSyncId);
        syncChannels[idx] = { ...syncChannels[idx], name, topic, password };
    } else {
        const newCh = { id: 'sync_' + Date.now(), name, topic, password };
        syncChannels.push(newCh);
        activeSyncId = newCh.id;
    }
    localStorage.setItem('tier_sync_channels', JSON.stringify(syncChannels));
    localStorage.setItem('tier_active_sync_id', activeSyncId);
    renderSyncUI();
    closeModal('syncAddModal');
}

function deleteSyncChannel(id) {
    if(!confirm("Kanal wirklich l√∂schen?")) return;
    syncChannels = syncChannels.filter(c => c.id !== id);
    if(activeSyncId === id) activeSyncId = null;
    localStorage.setItem('tier_sync_channels', JSON.stringify(syncChannels));
    renderSyncUI();
}

async function getActiveChannelObj() {
    const ch = syncChannels.find(c => c.id === activeSyncId);
    if(!ch) throw new Error("Bitte erst einen Kanal w√§hlen!");
    return ch;
}

/* === CONTEXT MENUS === */
function openCardMenu(event, id) {
    event.preventDefault(); event.stopPropagation();
    currentMenuTaskId = id;
    const menu = document.getElementById('cardContextMenu');
    menu.innerHTML = `
        <div class="context-item" onclick="handleMenuEdit()">‚úèÔ∏è Bearbeiten</div>
        <div class="context-item danger" onclick="handleMenuDelete()">üóëÔ∏è L√∂schen</div>
    `;
    showMenu(event, menu);
}

function openSyncChannelMenu(event) {
    if(!activeSyncId) return alert("Kein Kanal gew√§hlt!");
    const menu = document.getElementById('cardContextMenu');
    menu.innerHTML = `
        <div class="context-item" onclick="editSyncChannel('${activeSyncId}')">‚úèÔ∏è Kanal bearbeiten</div>
        <div class="context-item danger" onclick="deleteSyncChannel('${activeSyncId}')">üóëÔ∏è Kanal l√∂schen</div>
    `;
    showMenu(event, menu);
    event.stopPropagation();
}

function showMenu(e, menu) {
    menu.style.display = 'block';
    menu.style.left = e.clientX + 'px';
    menu.style.top = e.clientY + 'px';
}

function hideMenu() { document.getElementById('cardContextMenu').style.display = 'none'; }
window.addEventListener('click', hideMenu);

/* === CLOUD SYNC LOGIC === */
async function startCloudPush() {
    try {
        const ch = await getActiveChannelObj();
        const modal = document.getElementById('syncProgressModal');
        modal.style.display = 'flex';
        document.getElementById('syncProgressTitle').innerText = "Sende...";
        
        let payload = JSON.stringify({ version: "5.1", tasks: tasks, date: Date.now() });
        let encrypted = false;
        if (ch.password) {
            payload = await encryptText(payload, ch.password);
            encrypted = true;
        }

        const header = { type: "kb_header", encrypted, date: Date.now(), device: navigator.platform, size: payload.length };
        await fetch(`https://ntfy.sh/${ch.topic}`, { method: 'POST', body: JSON.stringify(header) });

        const CHUNK_SIZE = 100000; 
        const total = Math.ceil(payload.length / CHUNK_SIZE);
        for(let i=0; i<total; i++) {
            const chunk = payload.substring(i * CHUNK_SIZE, (i + 1) * CHUNK_SIZE);
            document.getElementById('syncProgressBar').style.width = ((i+1)/total * 100) + '%';
            await fetch(`https://ntfy.sh/${ch.topic}`, { method: 'POST', body: chunk, headers: {'X-Message-ID': `part_${i}`} });
        }
        document.getElementById('syncProgressTitle').innerText = "Erfolgreich! ‚úÖ";
        setTimeout(() => modal.style.display = 'none', 1200);
    } catch(e) { alert(e.message); document.getElementById('syncProgressModal').style.display = 'none'; }
}

async function checkForCloudBackups() {
    try {
        const ch = await getActiveChannelObj();
        const listItems = document.getElementById('syncListItems');
        listItems.innerHTML = "Suche...";
        document.getElementById('syncListContainer').style.display = 'block';

        const res = await fetch(`https://ntfy.sh/${ch.topic}/json?poll=1&since=12h`);
        const text = await res.text();
        const lines = text.trim().split('\n');
        const headers = lines.map(l => JSON.parse(l)).filter(m => m.message && m.message.includes('kb_header'));

        listItems.innerHTML = '';
        headers.reverse().forEach(h => {
            const data = JSON.parse(h.message);
            const date = new Date(data.date).toLocaleString();
            const div = document.createElement('div');
            div.className = 'sync-item';
            div.innerHTML = `<div><b>${date}</b><br><small>${data.encrypted?'üîí':'üîì'} ${data.device}</small></div>
                             <button class="btn-primary" style="padding:5px 10px; font-size:11px" onclick="loadFromCloud()">Laden</button>`;
            listItems.appendChild(div);
        });
        if(headers.length === 0) listItems.innerHTML = "Kein Backup in diesem Kanal.";
    } catch(e) { alert(e.message); }
}

async function loadFromCloud() {
    try {
        const ch = await getActiveChannelObj();
        const modal = document.getElementById('syncProgressModal');
        modal.style.display = 'flex';
        document.getElementById('syncProgressBar').style.width = '0%';

        const res = await fetch(`https://ntfy.sh/${ch.topic}/json?poll=1&since=12h`);
        const text = await res.text();
        const lines = text.trim().split('\n').map(l => JSON.parse(l));
        const chunks = lines.filter(l => l.message && !l.message.includes('kb_header')).map(l => l.message);
        let combinedPayload = chunks.join('');

        const headerMsg = lines.find(l => l.message && l.message.includes('kb_header'));
        const isEnc = headerMsg ? JSON.parse(headerMsg.message).encrypted : false;

        if(isEnc) {
            if(!ch.password) throw new Error("Passwort f√ºr diesen Kanal fehlt!");
            combinedPayload = await decryptText(combinedPayload, ch.password);
        }

        const data = JSON.parse(combinedPayload);
        if(data.tasks) {
            tasks = data.tasks;
            render();
            document.getElementById('syncProgressTitle').innerText = "Geladen! üöÄ";
            setTimeout(() => { modal.style.display = 'none'; closeModal('syncModal'); }, 1200);
        }
    } catch(e) { alert("Fehler: " + e.message); document.getElementById('syncProgressModal').style.display = 'none'; }
}

/* === BACKUP & CORE UTILS (Verschl√ºsselung wie index(23).html) === */
const enc = new TextEncoder();
const dec = new TextDecoder();
async function getKey(password, salt) {
    const keyMaterial = await window.crypto.subtle.importKey("raw", enc.encode(password), {name: "PBKDF2"}, false, ["deriveKey"]);
    return window.crypto.subtle.deriveKey({name: "PBKDF2", salt: salt, iterations: 100000, hash: "SHA-256"}, keyMaterial, {name: "AES-GCM", length: 256}, true, ["encrypt", "decrypt"]);
}
async function encryptText(text, password) {
    const salt = window.crypto.getRandomValues(new Uint8Array(16));
    const iv = window.crypto.getRandomValues(new Uint8Array(12));
    const key = await getKey(password, salt);
    const encrypted = await window.crypto.subtle.encrypt({name: "AES-GCM", iv: iv}, key, enc.encode(text));
    const buffer = new Uint8Array(salt.byteLength + iv.byteLength + encrypted.byteLength);
    buffer.set(salt, 0); buffer.set(iv, 16); buffer.set(new Uint8Array(encrypted), 28);
    return btoa(String.fromCharCode.apply(null, buffer));
}
async function decryptText(base64Data, password) {
    const bytes = new Uint8Array(atob(base64Data).split("").map(c => c.charCodeAt(0)));
    const salt = bytes.slice(0, 16); const iv = bytes.slice(16, 28); const data = bytes.slice(28);
    const key = await getKey(password, salt);
    const decrypted = await window.crypto.subtle.decrypt({name: "AES-GCM", iv: iv}, key, data);
    return dec.decode(decrypted);
}

function closeModal(id) { document.getElementById(id).style.display = 'none'; }
function openSyncModal() { document.getElementById('syncModal').style.display = 'flex'; }
function downloadBackup() {
    const data = JSON.stringify({ version: "5.1", tasks, date: new Date(), syncChannels }); // Sync-Kan√§le mit sichern!
    const blob = new Blob([data], {type: 'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `kanban-backup.json`; a.click();
}
function importBackup(e) {
    const file = e.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = (evt) => {
        try {
            const data = JSON.parse(evt.target.result);
            if (data.tasks) {
                if (confirm("Alles √ºberschreiben?")) {
                    tasks = data.tasks;
                    if(data.syncChannels) syncChannels = data.syncChannels;
                    localStorage.setItem('tier_sync_channels', JSON.stringify(syncChannels));
                }
                render(); closeModal('syncModal');
            }
        } catch(err) { alert("Datei besch√§digt"); }
    };
    reader.readAsText(file);
}

/* === RENDER & TASK FUNCTIONS === */
function render() {
    const search = document.getElementById('search').value.toLowerCase();
    ['todo', 'doing', 'done', 'q1', 'q2', 'q3', 'q4'].forEach(id => document.getElementById('list-' + id).innerHTML = '');

    tasks.forEach(task => {
        if (!task.text.toLowerCase().includes(search)) return;
        const createCard = () => {
    let qc = (task.urgent && task.important) ? "q1" : (!task.urgent && task.important) ? "q2" : (task.urgent && !task.important) ? "q3" : "q4";
    const card = document.createElement('div');
    card.className = `card ${qc}`;
    card.draggable = true;
    
    // Doppelklick-Edit Funktion
    card.ondblclick = () => editTask(task.id);
    
    card.ondragstart = (e) => { e.dataTransfer.setData('text', task.id); card.classList.add('dragging'); };
    card.ondragend = () => card.classList.remove('dragging');

    card.innerHTML = `
        <div class="card-text">${task.text}</div>
        <div class="card-meta">
            <span>${task.urgent ? '‚ö°' : ''}${task.important ? '‚≠ê' : ''}</span>
            <span>${new Date(task.id).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
        </div>
        <!-- Der Button wird durch CSS "position: absolute" nach rechts oben gezwungen -->
        <button class="card-menu-btn" onclick="openCardMenu(event, ${task.id})">‚ãÆ</button>
    `;
    return card;
};
        document.getElementById('list-' + task.status).appendChild(createCard());
        if(task.status !== 'done') {
            let qid = (task.urgent && task.important) ? "q1" : (!task.urgent && task.important) ? "q2" : (task.urgent && !task.important) ? "q3" : "q4";
            document.getElementById('list-' + qid).appendChild(createCard());
        }
    });
    localStorage.setItem('kanban-v4-1', JSON.stringify(tasks));
}

function addTask(status) {
    const input = document.getElementById('in-' + status);
    const u = document.getElementById('u-' + status).checked;
    const i = document.getElementById('i-' + status).checked;
    if (!input.value.trim()) return;
    tasks.push({ id: Date.now(), text: input.value, status, urgent: u, important: i });
    input.value = ''; document.getElementById('u-' + status).checked = false; document.getElementById('i-' + status).checked = false;
    render();
}
function editTask(id) {
    const t = tasks.find(x => x.id == id);
    const txt = prompt("√Ñndern:", t.text);
    if(txt) { t.text = txt; render(); }
}
function deleteTask(id) { if(confirm("L√∂schen?")) { tasks = tasks.filter(x => x.id != id); render(); } }
function handleMenuEdit() { if(currentMenuTaskId) editTask(currentMenuTaskId); hideMenu(); }
function handleMenuDelete() { if(currentMenuTaskId) deleteTask(currentMenuTaskId); hideMenu(); }
function allowDrop(e) { e.preventDefault(); const t = e.target.closest('.column') || e.target.closest('.quadrant'); if(t) t.classList.add('drag-over'); }
function clearStyle(e) { const t = e.target.closest('.column') || e.target.closest('.quadrant'); if(t) t.classList.remove('drag-over'); }
function drop(e, ns) { e.preventDefault(); clearStyle(e); const id = e.dataTransfer.getData('text'); const t = tasks.find(x => x.id == id); if(t) { t.status = ns; render(); } }
function dropMatrix(e, ur, im) { e.preventDefault(); clearStyle(e); const id = e.dataTransfer.getData('text'); const t = tasks.find(x => x.id == id); if(t) { t.urgent = ur; t.important = im; render(); } }
function clearAll() { if(confirm("Board resetten?")) { tasks = []; render(); } }


</script>
</body>
</html>
